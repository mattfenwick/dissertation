\chapter{Reproducible NMR data sets}

\begin{center}
  \textit{Our responsibility is to do what we can, learn what we can, 
    improve the solutions, and pass them on.}

 - Richard Feynman
\end{center}

% TODO make sure to point out that there's multiple ways to do this
% there's different NMR-domain approaches
% but there's also both the git-based and NMR-Star-based approaches

In order to prove the validity of the approach described in the previous
chapter, it was applied to typical NMR data in order to solve a protein
structure.  The process was carried out in full, and sufficient data was
captured during the process in order to render it reproducible.


\section{Methods and Materials}

Time-domain data of Samp3, a Ubiquitin-like protein, were kindly provided by 
Dr. Mark Maciejewski.  The data were processed to frequency-domain spectra
using NMRPipe, and then analyzed first in CCPN Analysis \cite{ccpn} and later 
in Sparky \cite{sparky}.  A preliminary analysis process used CCPN Analysis,
along with git and several Python utilities to create and manage the 
reproducible history.  The final analysis used Sparky, the model and approach
described in the previous chapter, the extension described in the following
chapter, and the extensions to the NMR-Star data dictionary.  
Cyana was used to assign NOEs,
disambiguate stereospecific assignments, and calculate structure bundles.
% TODO more detail?  pictures?


\section{The analysis process}
Starting from frequency spectra, I carried out standard data analysis,
with the additional property that the analysis is reproducible.

\subsection*{Initial peak picking and GSS construction}
First, the NHSQC and HNCO spectra were peak picked using an automated 
peak picker -- see Table \ref{samp3_spectra} for a complete list of spectra
used.  Then GSSs were built based on NHSQC peaks and matching HNCO peaks
according to the H and N dimensions.  Peaks either in the NHSQC or HNCO
which did not match peaks in the other spectra were verified manually, and
many were labeled as extraneous and not included in GSSs.

Several sidechain spin systems, including Asparagine, Glutamine, Tryptophan,
and Arginine, were identified based on either peaks with matching N and C
chemical shifts but different H shifts, spectral position, or peak intensity
combined with splitting.  An example of an Asparagine sidechain is shown in
Figure \ref{asn_sidechain}.  Several factors allow these peaks to be grouped
into a single GSS, and that GSS to be typed as an Asparagine:
\begin{itemize}
  \item two peaks in the NHSQC with matching N frequencies, but different H
    frequencies, in the top right of the spectrum.  These are caused by the
    two non-equivalent protons on the sidechain N.
  \item two additional, less intense peaks in the NHSQC matching the two
    H frequencies but at a lower PPM in the N dimension.  These are caused by
    a small fraction of the sample which has one D and one H.
  \item two peaks in the HNCACB matching each of the D/H peaks in the NHSQC,
    and matching each other as well.  These are caused by the CB and CA; 
    however, the signs of the peaks are swapped from what they should be for
    a backbone GSS, since the CB is now closer to the H-N group than the CA.
  \item characteristic chemical shifts which match a CB/CA of Asparagine, 
    and do not match a CG/CB of Glutamine.
\end{itemize}

\subsection*{GSS and resonance typing}
Analysis continued with peak picking of the HNCACB and C(CO)NH-Tocsy spectra.
The inclusion of the H and N dimensions allowed these peaks to be added into
GSSs based on the matching of these two chemical shift values to the
root peaks of existing GSSs.  There was some H/N overlap which complicated the
task of unambiguous peak-GSS assignment, but it was mostly resolved through
the extra Carbon dimensions, which allowed peaks to be identified separately
and with more precise chemical shift values.

The overlap between the two spectra -- peaks of sidechain i-1 Carbons, relative
to a backbone amide group, appeared in both spectra, while only the i peaks
appeared in the HNCACB -- allowed for assignment of resonance type of HNCACB
peaks and some C(CO)NH-Tocsy peaks.  Additionally, for GSSs with more than two
i-1 Carbon atoms, the C(CO)NH-Tocsy resonance typings were simplified by the
removal of CA and CB assignment possibilities due to overlap with the HNCACB.

The Carbon chemical shifts provided sufficient information for GSS typing
in many cases.  The number of peaks in C(CO)NH-Tocsy strips also provided 
information about the typing of the previous GSS, the use of which is described
in the following section.

\subsection*{Sequential and residue-specific GSS assignment}
GSSs were built into sequential chains based on overlap of CA(i) and CB(i) 
peaks of one GSS with CA(i-1) and CB(i-1) peaks of another.  It was critical
that the overlap be unambiguous; ambiguous overlaps were deferred until later
when additional information would provide disambiguation.
Simultaneously, chains were assigned to residue sequences based on GSS typing
and chain order matching the residue typing and chain order.  GSS chains
were often anchored on a Glycine, Serine, Threonine, or Alanine residue due
to their unique Carbon chemical shifts.

The whole process was heavily interdependent for several reasons.  First, by
assigning a GSS chain to specific residues, the typing for the GSSs both
immediately preceding, and immediately following the first and last GSSs,
respectively, of the chain were implied; this narrowed the search for further
GSSs to those either with the appropriate typing, or an unassigned typing but
with chemical shifts that matched the average BMRB statistics sufficiently 
well.  It was also necessary that these GSSs were not already assigned as 
part of a GSS chain because ambiguous assignments were disqualified.
Second, assigning a GSS chain to residues reduced the number of unassigned
residues, and therefore the number of possibilities for other unassigned chains
as well.  It was several times the case that assigning a chain led immediately
to the assignment of another chain by the process of elimination.  Third,
assigning GSSs sequentially narrowed the number of places in the sequence that
could potentially accomodate the chain, both because of the chain-ending
constraints imposed by Proline residues as well as the necessity of matching
all GSS typing to residue typing.

\subsection*{Sidechain: GSS augmentation and resonance typing}
The C(CO)NH-Tocsy provided information on the chemical shifts of aliphatic
sidechain carbons, as covered in the previous section.  The HBHA(CO)NH, 
HC(CO)NH-Tocsy, and HCCH-Tocsy provided the chemical shifts of aliphatic
protons, as well as additional corroborating information of aliphatic carbons.

First, these spectra were peak picked, as before, by an automated peak picker.
The results were then corrected in a coarse validation step, before assembling
the peaks into GSSs based on matching chemical shifts.  For the HC(CO)NH-Tocsy
and HBHA(CO)NH spectra, this was based on matching of backbone H and N
resonances and was unambiguous for the most part.  The HCCH-Tocsy, lacking these
resonaces, was based on matching to sidechain H and C resonances, and was
slightly more difficult to interpret due to ambiguities.  
Average BMRB statistics as well as peak patterns based on prochiral methylene
groups were sufficient for resonance typing.
% TODO show some HCCH-Tocsy strips

\subsection*{Aromatic assignment}
The two final through-bond experiments, the hbCBcgcdHD and hbCBcgcdceHE, were
used to find the HD and HE resonances of aromatic sidechains and place them
into the correct GSS.  The spectra were again peak picked with an automated
peak picker, and then assigned by matching the C dimension with the previously
analyzed CB chemical shifts: the GSS with a matching CB(i) resonance was the
appropriate one.

\subsection*{NOE assignment and structure calculation}
The four NOESY spectra were peak picked with an automated peak picker.  
Talos+ \cite{talos+} was run on the chemical shift assignments of the H, HA,
CA, CB, CO, and N nuclei in order to generate Phi and Psi torsion angle 
constraints for backbone conformation.
The Talos+ results can be seen in Figure \ref{talos+_results}.

Cyana was then run by providing it the NOESY peak lists, chemical shift
assignments, torsion angle constraints, and Samp3 sequence.  The script
used for running Cyana is shown here:
\begin{verbatim}
# NOESY peak lists in XEASY format
peaks       := aromatic_gnoesy_chsqc.pks,aromatic_noesy.pks,
               D2O_noesy_chsqc.pks,noesy_nhsqc.pks
# names of chemical shift lists
prot        := shifts.txt                
# additional (non-NOE) restraints
restraints  := aco.aco                   
# shift tolerances: H, H', C/N', C/N
tolerance   := 0.04, 0.03, 0.45          
# number of initial, final structures
structures  := 100,20                    
# number of torsion angle dynamics steps
steps       := 10000                    
# random number generator seed
randomseed  := 434726                    

nproc=8

noeassign peaks=$peaks prot=$prot autoaco
\end{verbatim}
After running Cyana once, the output indicated issues with stereospecificity
of certain assignments (methylene protons, as well as Leucine and Valine
CG groups).  These assignments were corrected according to Cyana's feedback,
and Cyana re-run with the corrected stereospecific assignments.
The final structure is shown in Figure \ref{structure} as seen in jmol.


\section{NMR-Star data set}
% TODO get the data set
% what should I talk about here?  the various approaches and deductions used?
% queries performed on the data, that show certain things?
% the order in which I did things?


\section{Archiving reproducible data sets}
A major portion of the value derived from collecting reproducible data sets
is disseminating them so that others may obtain and use or inspect the data
in some way.  The standard means for sharing NMR-derived data is the BMRB
\cite{bmrb}, which uses the NMR-Star file format.  In order to enable archival
of reproducible data sets, we have collaborated with the BMRB to extend the
NMR-Star data dictionary, so that reproducible data sets may be collected and
deposited in the NMR-Star format.

The NMR-Star data dictionary, which may be found at 
\url{http://www.bmrb.wisc.edu/dictionary/}, catalogs the names, structure,
intended use, and definitions of the data types handled by the BMRB.


\section{Difficulties encountered}

NMR data analysis faces the inherent issues of false positives, false 
negatives, ambiguity, and extraneous data.
During the analysis of Samp3, I encountered these difficulties many times.  
Because my analysis was reproducibly recorded, exactly which
difficulties I encountered and how I resolved them is explicitly recorded
in the final data set.  This section will cover several specific instances 
of these problems that I encountered.

\subsection*{False positive peaks}
The automated peak picker found several peaks which later turned out to
not be signal.  These were often artifactual in natures, but occasionally 
appeared to be noise.  See Figure \ref{false_positive} for an example.

\subsection*{False negative peaks}
The automated peak pickers missed several low-intensity true peaks.
These were often solved either by lowering the contour levels and manually
picking peaks which were clearly above the noise level, or by using 
information from additional spectra as well as the current resonance and 
GSS assignments, allowing a putative spin system to be located by means of
the existing chemical shift assignments of resonances.
See Figure \ref{false_negative} for an example of a true signal peak which
was not picked by the automated peak picker.

\subsection*{Overlap}
Overlap was a problem both for correctly identifying and characterizing peaks,
and for constructing GSSs and assigning peaks into them correctly.
It was difficult to resolve overlap until late in the analysis process, when
GSS typing, peak picks from additional spectra, and sequential GSS assignments
were available.
See Figure \ref{overlap} for an example.

\subsection*{Ambiguous sequential GSS assignments}
Assigning GSS to GSS sequentially was occasionally ambiguous, on the basis of
a naive matching algorithm using only HNCACB peaks.  This was because it is
not always clear from the HNCACB which peaks are CA(i) and CB(i) versus CA(i-1)
and CB(i-1).  However, by using the C(CO)NH-Tocsy in conjunction with the
HNCACB, the i/i-1 distinction was mostly resolved.  This left the problem of
multiple matches, which was eventually solved by taking into account additional
sequence and GSS typing information.
% TODO example

\subsection*{Extraneous GSSs}
Several unassigned GSSs remain in the data set.  I have not determined whether
these are due to contaminants, multiple conformations of the Samp3 protein,
or perhaps they correspond to one of the few remaining unassigned residues.
However, since they are still in the final data set, and are clearly unassigned,
it is explicitly made clear that these are an issue.
% TODO maybe the GSS id shouldn't be in the picture, in case it changes later
See Figure \ref{extraneous_gss} for an example of an unassigned GSS, but 
which is nevertheless most likely a true GSS.


\section{Alternative implementations}

While the approach taken was to create the data set as a single NMR-Star
file for reasons of compatibility with existing programs and data archival
and retrieval facilities, there are other solutions to this problem.  This
section will inspect the strengths and weaknesses of an alternative solution
which was taken during preliminary stages of this project.

The approach centered around using the open source VCS tool git 
\cite{loeliger2012git}.  A VCS tool enables the history of filesystem trees,
typically source code trees of software projects, to be captured in a series
of successive snapshots.  Git, as a distributed VCS, includes a more robust
model of snapshot history, which was critical in the success of its 
application to NMR data analysis.

Using git, multiple snapshots of a JSON or NMR-Star flat text file were
taken during the analysis process.  Each snapshot was annotated with a 
JSON formatted string which provided the deductive reasoning behind the change,
as well as a timestamp, author, and parent commit.  This approach was initially
employed due to git's intended use aligning very well with the domain problem.

The solution was quite easy, flexible, and robust in practice.  Git is a mature,
popular tool and therefore it was easy to learn to use, and contains many
features for creating, tracking and querying the history.  Here is a code 
snippet that shows how to create and annotate a new snapshot using git; all
commands are run from a standard shell:
\begin{verbatim}
# prepare two files -- peaks and parameters -- for snapshotting
$ git add nhsqc_peaks.str peak_picker_parameters.str

# create a snapshot, and annotate with a structured reason
$ git commit -m "{\"reason": "automated Sparky peak picker\"}"

# display the history of commits in the project
$ git log
\end{verbatim}

The git approach was the inspiration for the solution eventually employed.
There is an inherent tradeoff between the two approaches: in the git approach,
the full data set is spread across multiple snapshots of files, and the meta
data is also separate from the primary data.  In the NMR-Star based approach,
all the data, primary and meta, is in a single file.  While the git approach
makes it easier to query a single snapshot in time, it is more difficult to
query across multiple snapshots, or meta data.  The single file approach makes
it more difficult to query a single snapshot (other than the most recent one),
but easier to query across the complete data set including meta data.  It is
important to note that these differences are merely incidental, and not 
fundamental -- the same data is represented and stored in both approaches, it
is merely writing specific queries that becomes somewhat harder or easier.

Git includes additional features that were not taken advantage of in our
implementation, which could perhaps prove valuable at some later date.  An
important example is branches, which allow data analysis to fork and rejoin.
% TODO need a figure
This could potentially be useful for interpreting ambiguous or unclear features
in multiple ways, because it would allow an explicit record of the choice point.
It could also be useful for error correction, to show the cascading effect of
an incorrect analysis early in the process.


\section{Discussion}
Applying the reproducibility approach, described in the previous chapter, first
and foremost proves that the approach is viable: that it can be used to 
effectively analyze NMR data, and lead to a final data set which is usable.  
The approach I have applied is not the only one 
which could possibly be employed; rather, it is one of several.  The principles
embodied in the approach are to make data explicit -- whether that data is the
context of a deduction, or the deduction itself, or the motivation behind a
deduction -- and to capture that data efficiently.  In this respect, it is 
similar to recording the process of analysis in a lab notebook, except that 
the data requirements for the electronic "lab notebook" are far larger.
The overal proof of the effectiveness of such an electronic lab notebook is
that the relevant information is explicitly captured, such that it is made
available for later perusal.  This approach does effectively capture such 
information.  This ground-breaking work also shows how to
use the approach, including possible pitfalls;  the final, reproducible data
set is valuable in that it shows what can be achieved through a reproducible
approach, as well as creating a platform for future work towards enhanced
reproducibility.


% tables
\clearpage
\section{Tables}

\begin{table}[h]
    \begin{tabular}{ | c || c | c | c | c | c |}
    \hline
      Name  &  Dimension 1  &  Dimension 2  &  Dimension 3  &  Is NOESY?   \\
    \hline
      NHSQC         & H & N & & No  \\
    \hline
      HNCO          & H & N & C & No  \\
    \hline
      HNCACB        & H & N & C & No  \\
    \hline
      C(CO)NH-Tocsy & H & N & C & No  \\
    \hline
      HBHA(CO)NH    & H & N & H & No  \\
    \hline
      HC(CO)NH-Tocsy & H & N & C & No  \\
    \hline
      HCCH-Tocsy    & H & C & H & No  \\
    \hline
      hbCBcgcdHD    & H & C &  & No  \\
    \hline 
      hbCBcgcdceHE  & H & C &  & No \\
    \hline
      NOESY-NHSQC   & H & N & H & Yes \\
    \hline 
      NOESY-CHSQC (D\textsubscript{2}O) & H & C & C & Yes \\
    \hline 
      Aromatic NOESY & H & H &  & Yes \\
    \hline 
      Aromatic GNOESY-CHSQC & H & C & H & Yes \\
    \hline 
    \end{tabular}
    \caption{Spectra used in Samp3 analysis}
    \label{samp3_spectra}
\end{table}


\clearpage
\section{Figures}

\begin{figure}[h]
  \includegraphics[scale=0.25]{figures/asn_sidechain}
  \caption{An Asparagine sidechain in the NHSQC and HNCACB spectra.}
  \label{asn_sidechain}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/talos+_results}
  \caption[The secondary structure prediction according to Talos+.]
          {The torsion angles and secondary structure prediction 
           according to Talos+, along with a confidence interval.  
           These results can be shown in a Ramachandran plot.}
  \label{talos+_results}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/structure}
  \caption[The final structure as seen in jmol.]
          {The final structure as seen in jmol.
           Secondary structure is visible: beta-sheets as parallel and
           anti-parallel arrows, and alpha-helices as coiled ribbons.}
  \label{structure}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/false_negative}
  \caption[A false negative -- a true signal missed by the automated peak picker.]
          {A false negative -- a true signal missed by the automated peak picker.
           Its intensity compared to the spectral noise level, as well as 
           peaks in additional spectra whose frequencies in multiple cross
           sections match this peak, indicate that it is a true peak.}
  \label{false_negative}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/false_positive}
  \caption[A false positive peak, found by the automated peak picker.]
          {A false positive peak, found by the automated peak picker.
           The sign of the peak, as well as its intensity and position
           compared to the true peak next to it, indicate that it is false.}
  \label{false_positive}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/overlap}
  \caption{Overlap between two GSSs based on their NHSQC roots.}
  \label{overlap}
\end{figure}

\begin{figure}
  \includegraphics[scale=0.25]{figures/extraneous_gss}
  \caption{An extraneous GSS.  It was not assigned to any specific residue.}
  \label{extraneous_gss}
\end{figure}

